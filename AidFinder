import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.Scanner;

public class AidFinder {
    private static final String API_URL = "https://api.openai.com/v1/chat/completions";
    private static final String API_KEY = System.getenv(API_KEY);
    //System.out.println("API_KEY: " + API_KEY);

    public void listScholarships(String userQuery) {
        if (API_KEY == null || API_KEY.isEmpty()) {
            //System.err.println("Error:" + API_KEY "environment variable is not set.");
            System.out.println("Error: API_KEY environment variable is not set.");
            return;
        }

        try {
            URL url = new URL("https://api.openai.com/v1/chat/completions");
            HttpURLConnection conn = (HttpURLConnection) url.openConnection();

            conn.setRequestMethod("POST");
            conn.setRequestProperty("Authorization", "Bearer " + API_KEY);
            conn.setRequestProperty("Content-Type", "application/json");
            conn.setDoOutput(true);

            String requestBody = String.format("""
                {
                  "model": "gpt-3.5-turbo",
                  "messages": [
                    { "role": "system", "content": "You are a helpful assistant that finds scholarships for students based on their needs and gives a description of each." },
                    { "role": "user", "content": "%s" }
                  ]
                }
                """, userQuery.replace("\"", "\\\"")); // escape quotes

            try (OutputStream os = conn.getOutputStream()) {
                os.write(requestBody.getBytes());
            }

            int status = conn.getResponseCode();
            Scanner scanner = new Scanner(
                status == 200 ? conn.getInputStream() : conn.getErrorStream()
            ).useDelimiter("\\A");

            String response = scanner.hasNext() ? scanner.next() : "";

            if (status == 200) {
                // Extract and display the assistant's message (raw JSON response shown for now)
                System.out.println("\nðŸŽ“ Scholarships Found:\n" + response);
            } else {
                System.out.println("API Error " + status + ": " + response);
            }

            conn.disconnect();

        } catch (Exception e) {
            System.err.println("Error: " + e.getMessage());
        }
    }
}
